# Compliance Dashboard - Feature Documentation

## üéØ Overview

The Compliance & Security tab now features a **fully interactive dashboard** with real-time metrics and professional PDF report generation instead of static badges.

## üìä What's New?

### 1. **Interactive Visual Dashboard**

#### Real-Time Metrics
- **Total Deliveries**: Count of all deliveries in the system
- **Total Accesses**: Number of audit log events
- **Success Rate**: Percentage of successful authentication attempts
- **Average Retention**: Average document retention time in days

#### Interactive Charts
1. **Access Trend (Line Chart)**
   - 6-month historical view
   - Successful vs Failed attempts
   - Identify patterns and anomalies

2. **Delivery Status Distribution (Pie Chart)**
   - Active deliveries
   - Expired deliveries
   - Revoked deliveries

3. **Action Type Distribution (Bar Chart)**
   - Views
   - Downloads
   - Access attempts
   - Expired events

4. **Top Access Locations (Progress Bars)**
   - Top 5 geographic locations
   - Percentage breakdown
   - Total unique locations count

#### Month-over-Month Analysis
- Current month activity
- Previous month comparison
- Percentage change with trend indicators (‚Üë or ‚Üì)

### 2. **Professional PDF Report Generation**

Click **"Export PDF Report"** to generate a comprehensive compliance report including:

#### Report Sections
1. **Executive Summary**
   - Organization name
   - Generation date
   - Overview of compliance posture

2. **Key Metrics Table**
   - Total deliveries & status
   - Access events & success rate
   - Failed attempts
   - Retention time
   - Auto-destruction rate

3. **Compliance Standards Certification**
   - GDPR compliance status
   - HIPAA readiness
   - SOC 2 Type II alignment
   - ISO 27001 alignment
   - CCPA/CPRA compliance

4. **Recent Audit Events**
   - Last 50 audit log entries
   - Timestamp, action, document, status, IP
   - Formatted for easy review

5. **Security Certifications**
   - AES-256 encryption
   - Immutable audit logging
   - RBAC
   - Auto-destruction
   - Zero-knowledge architecture
   - IP logging & geolocation

6. **Footer**
   - Generated by (user name)
   - Report ID
   - Page numbers
   - Sealdrop branding

## üöÄ How to Use

### Accessing the Dashboard

1. Navigate to **Audit** in the sidebar
2. Click on the **"Compliance & Security"** tab
3. The dashboard loads automatically with real-time data

### Generating Reports

1. Review the metrics and charts
2. Click **"Export PDF Report"** button (top-right)
3. PDF downloads automatically
4. Filename format: `compliance-report-YYYY-MM-DD.pdf`

### Use Cases

#### For Clients
- Send compliance reports to clients who need proof of data protection
- Demonstrate GDPR/HIPAA compliance
- Show audit trail capabilities

#### For Audits
- Provide to external auditors during security reviews
- SOC 2 Type II compliance evidence
- ISO 27001 certification support

#### For Internal Review
- Monthly compliance check-ins
- Security posture assessment
- Trend analysis for security improvements

## üîß Technical Details

### API Endpoints

#### GET `/api/audit/compliance-metrics`
Returns comprehensive compliance metrics:
```json
{
  "success": true,
  "metrics": {
    "overview": {
      "totalDeliveries": 150,
      "activeDeliveries": 45,
      "expiredDeliveries": 95,
      "revokedDeliveries": 10,
      "totalAccesses": 523,
      "successfulAccesses": 510,
      "failedAccesses": 13,
      "failureRate": 2.48
    },
    "timeBased": {
      "currentMonth": 89,
      "lastMonth": 112,
      "avgRetentionDays": 7.3
    },
    "geographic": {
      "topLocations": [
        { "location": "Santiago, Chile", "count": 234 },
        ...
      ],
      "uniqueLocations": 12
    },
    "actions": {
      "distribution": {
        "view": 234,
        "download": 156,
        "access_attempt": 13,
        ...
      }
    },
    "autoDestruction": {
      "total": 87,
      "percentage": 58.0
    },
    "trend": [
      {
        "month": "Jun 2024",
        "accesses": 45,
        "successful": 43,
        "failed": 2
      },
      ...
    ]
  }
}
```

#### POST `/api/audit/generate-compliance-report`
Generates and returns a PDF report as binary data.

**Response Headers:**
- `Content-Type: application/pdf`
- `Content-Disposition: attachment; filename="compliance-report-{date}.pdf"`

### Libraries Used

- **jspdf**: PDF document generation
- **jspdf-autotable**: Professional table formatting in PDFs
- **recharts**: Interactive React charts
- **date-fns**: Date formatting and manipulation

### Data Flow

```
User clicks "Compliance & Security" tab
    ‚Üì
Frontend calls GET /api/audit/compliance-metrics
    ‚Üì
API aggregates data from:
  - deliveries table
  - audit_logs table
  - Filters by user role (admin = all org, user = own)
    ‚Üì
Metrics returned to frontend
    ‚Üì
Recharts renders interactive visualizations
    ‚Üì
User clicks "Export PDF Report"
    ‚Üì
Frontend calls POST /api/audit/generate-compliance-report
    ‚Üì
API fetches same metrics + recent audit logs
    ‚Üì
jsPDF generates professional PDF
    ‚Üì
PDF downloaded to user's device
```

## üìà Metrics Explained

### Success Rate
```
Success Rate = ((Total Accesses - Failed Accesses) / Total Accesses) √ó 100
```
Higher is better. <95% may indicate security issues.

### Failure Rate
```
Failure Rate = (Failed Accesses / Total Accesses) √ó 100
```
Lower is better. >5% requires investigation.

### Average Retention
```
Avg Retention = Œ£(expiration_date - creation_date) / Total Completed Deliveries
```
Days between creation and expiration for completed deliveries.

### Auto-Destruction Percentage
```
Auto-Destruction % = (Auto-Destructed / Total Deliveries) √ó 100
```
Deliveries that reached limits (views/downloads/attempts) vs manually revoked.

## üé® Customization

### Changing Chart Colors
Edit `COLORS` array in `ComplianceDashboard.tsx`:
```typescript
const COLORS = ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884D8"];
```

### Adding More Metrics
1. Update `GET /api/audit/compliance-metrics` to calculate new metric
2. Add metric to response type
3. Display in `ComplianceDashboard.tsx`

### PDF Customization
Edit `generateCompliancePDF()` function in:
`src/app/api/audit/generate-compliance-report/route.ts`

## üîí Security & Privacy

- **Admin only**: Only admins/owners can see org-wide metrics
- **User isolation**: Regular users only see their own delivery metrics
- **RLS enforced**: All database queries respect Row Level Security
- **No PII in PDFs**: Reports contain aggregated data, not individual user info

## üìù Future Enhancements

Potential improvements:
- [ ] Email scheduled reports (weekly/monthly)
- [ ] Custom date range selection
- [ ] Export metrics as CSV/Excel
- [ ] Real-time alerts for security events
- [ ] Compliance score calculation
- [ ] Benchmark against industry standards
- [ ] Multi-language PDF reports
- [ ] Custom branding (logo, colors)

## üêõ Troubleshooting

### No data showing in charts
- Check that you have audit logs in the database
- Verify user has proper permissions (admin for org view)
- Check browser console for API errors

### PDF generation fails
- Ensure jspdf and jspdf-autotable are installed
- Check that metrics API returns valid data
- Verify user is authenticated

### Charts not rendering
- Recharts requires valid numeric data
- Check that metrics contain arrays with data
- Verify chart dimensions are set

## üìû Support

For issues or questions:
1. Check the logs in browser console
2. Review API response in Network tab
3. Verify database has audit_logs data

---

**Last Updated**: November 2024
**Version**: 1.0.0
